---
title: "DGE analysis of SLCs"
output: 
  html_document: 
    df_print: paged
---
```{r}
# Load count data
library(tidyverse)
library(stringr)
library(dplyr)
library(edgeR)
counts.data <- read_tsv("../Input/GTEx_SLCs_gene_reads.gct")
samp.anno.data <- read_tsv("../Input/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt")
subj.anno.ds.data <- read_tsv("../Input/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt")
counts.data <- counts.data[,-1]

# create a sub-data set
#counts.data.copy <- counts.data
#counts.data <- counts.data.copy
#subcounts.data <- counts.data[,1:10]
# check count data of first 10 sample in graph
#subcounts.data %>% 
#  pivot_longer(colnames(subcounts.data[,-1]), names_to="sample", values_to="value") %>% 
#    ggplot(aes(x=value)) +
#    facet_wrap("sample") +
#    geom_histogram()

# Check if count data of first 10 sample normally distributed after transformation by log10
#subcounts.data %>% 
#  pivot_longer(colnames(subcounts.data[,-1]), names_to="sample", values_to="value") %>% 
#  ggplot(aes(x=value)) +
#  scale_x_log10() +
#  facet_wrap("sample") +
#  geom_histogram()

#counts.data <- counts.data[rowSums(counts.data[,-1] > 10) >= 3,]
# No need to select because all SLCs gene are with some expression




# Retrieve the count data of 2 among so many various tissues to analyse. Subsequent analysis should count all the data
tiss1.sampid <- samp.anno.data %>% 
  filter(SMTS=='Ovary') %>% 
  select(SAMPID)

tiss2.sampid <- samp.anno.data %>% 
  filter(SMTS=='Testis') %>% 
  select(SAMPID)



### Take only several samples for plotting


#ids <- tiss1.sampid[1:10,] %>% 
#  bind_rows(tiss2.sampid[1:10,]) %>% 
#  add_row(SAMPID='Description') %>% 
#  pull() %>% 
#  paste(collapse="|")
### End here

ids <- tiss1.sampid %>% 
  bind_rows(tiss2.sampid) %>% 
  add_row(SAMPID='Description') %>% 
  pull() %>% 
  paste(collapse="|")








counts.data <- counts.data %>% 
  select(matches(ids))

# Create a tibble for edgeR description
tiss1.sampid <- tiss1.sampid %>% 
  mutate(TS='Ovary')

tiss2.sampid <- tiss2.sampid %>% 
  mutate(TS='Testis')

sample.description <- tiss1.sampid %>% 
  bind_rows(tiss2.sampid) %>%
  mutate(SUBJID=str_extract(SAMPID, 'GTEX-.+(?=-.+-SM)')) %>%
  left_join(subj.anno.ds.data, by='SUBJID') %>% 
  mutate(group=paste(TS, SEX, AGE, DTHHRDY, sep="_")) %>% 
  select(-SUBJID)

sample.description <- sample.description %>%
  mutate(TS=factor(TS,levels = c("Testis","Ovary")),
         SEX=factor(SEX,levels = c(1,2)),
         AGE=factor(AGE,levels = c("20-29","30-39","40-49","50-59","60-69","70-79")),
         DTHHRDY=factor(DTHHRDY,levels = c(0,1,2,3,4))) # setting the levels in this way makes "Testis" the reference  

# Calculate normalization factors
counts.matrix <- counts.data %>% select(-Description) %>% as.matrix()
rownames(counts.matrix) <- counts.data$Description

sample.description <- tibble(SAMPID=colnames(counts.matrix)) %>%
  left_join(sample.description)
#

dge.data <- DGEList(counts=counts.matrix, 
                    group=sample.description$group)
 
dge.data <- calcNormFactors(dge.data, method = "TMM")
dge.data$samples

# Make a plot of the Biological Coefficient of Variation of each sample
color_info <- sample.description[,1:2] %>% 
  mutate(color=ifelse(TS=="Testis","darkred","lightgreen")) %>% 
  select(-TS)

matched_colors <- color_info$color[match(colnames(dge.data), color_info$SAMPID)]

plotMDS(dge.data, method = "logFC", pch=16, col=matched_colors)


### To investigate why there's sightly variance with testis group
#diff <- sample.description %>% 
#  filter(SEX==1) %>% 
#  left_join(samp.anno.data)

# Normalization and check the effect of normalization
counts.data.normal <- cpm(dge.data) 

# or log2 transformed:
counts.data.normal.log <- cpm(dge.data,log = TRUE)

counts.data.log <- log2(counts.data[,-1] + 1)

counts.data.log.pvt <- counts.data.log[,sample(ncol(counts.data.log), 6)]

counts.data.log.pvt <- counts.data.log.pvt %>% pivot_longer(colnames(counts.data.log.pvt), names_to="sample", values_to="value")
counts.data.log.pvt %>% ggplot(aes(x=sample, y=value)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))

counts.data.normal.log.pvt <- data.frame(counts.data.normal.log)[,sample(ncol(counts.data.normal.log), 6)]
  

counts.data.normal.log.pvt <- counts.data.normal.log.pvt %>% pivot_longer(colnames(counts.data.normal.log.pvt), names_to="sample", values_to="value")
counts.data.normal.log.pvt %>% ggplot(aes(x=sample, y=value)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))


# Calculate dispersion factors
design <- model.matrix(~TS,data = sample.description)
rownames(design) <- sample.description$SAMPID

#First the overall dispersion
dge.data <- estimateGLMCommonDisp(dge.data,design,verbose = TRUE)

#Then a trended dispersion based on count level
dge.data <- estimateGLMTrendedDisp(dge.data,design)

#And lastly we calculate the gene-wise dispersion, using the prior estimates to "squeeze" the dispersion towards the common dispersion.
dge.data <- estimateGLMTagwiseDisp(dge.data,design)

#We can examine this with a plot
plotBCV(dge.data)

# Find differentially expressed genes

fit <- glmFit(dge.data, design)

gt.lrt <- glmLRT(fit,coef = "TSOvary")

topTags(gt.lrt)

summary(decideTestsDGE(gt.lrt,p.value=0.01))
```

