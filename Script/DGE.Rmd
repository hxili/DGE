---
title: "DGE analysis of SLCs"
output: 
  html_document: 
    df_print: paged
---
```{r}
# load count data
library(tidyverse)
library(stringr)
library(dplyr)
library(edgeR)
counts.data <- read_tsv("../Input/GTEx_SLCs_gene_reads.gct")
samp.anno.data <- read_tsv("../Input/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt")
subj.anno.ds.data <- read_tsv("../Input/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt")
counts.data <- counts.data[,-1]

# create a sub-data set
counts.data.copy <- counts.data
#subcounts.data <- counts.data[,1:10]
# check count data of first 10 sample in graph
#subcounts.data %>% 
#  pivot_longer(colnames(subcounts.data[,-1]), names_to="sample", values_to="value") %>% 
#    ggplot(aes(x=value)) +
#    facet_wrap("sample") +
#    geom_histogram()

# check if count data of first 10 sample normally distributed after transformation by log10
#subcounts.data %>% 
#  pivot_longer(colnames(subcounts.data[,-1]), names_to="sample", values_to="value") %>% 
#  ggplot(aes(x=value)) +
#  scale_x_log10() +
#  facet_wrap("sample") +
#  geom_histogram()

#counts.data <- counts.data[rowSums(counts.data[,-1] > 10) >= 3,]
# no need to select because all SLCs gene are with some expression




# retrieve the count data of 2 among so many various tissues to analyse. Subsequent analysis should count all the data
tiss1.sampid <- samp.anno.data %>% 
  filter(SMTS=='Ovary') %>% 
  select(SAMPID)

tiss2.sampid <- samp.anno.data %>% 
  filter(SMTS=='Testis') %>% 
  select(SAMPID)

ids <- tiss1.sampid %>% 
  bind_rows(tiss2.sampid) %>% 
  add_row(SAMPID='Description') %>% 
  pull() %>% 
  paste(collapse="|")

counts.data <- counts.data %>% 
  select(matches(ids))

# create a tibble for edgeR description
tiss1.sampid <- tiss1.sampid %>% 
  mutate(TS='Ovary')

tiss2.sampid <- tiss2.sampid %>% 
  mutate(TS='Testis')

sample.description <- tiss1.sampid %>% 
  bind_rows(tiss2.sampid) %>%
  mutate(SUBJID=str_extract(SAMPID, 'GTEX-.+(?=-.+-SM)')) %>%
  left_join(subj.anno.ds.data, by='SUBJID') %>% 
  mutate(group=paste(TS, SEX, AGE, DTHHRDY, sep="_")) %>% 
  select(-SUBJID)

sample.description <- sample.description %>%
  mutate(TS=factor(TS,levels = c("Testis","Ovary")),
         SEX=factor(SEX,levels = c(1,2)),
         AGE=factor(AGE,levels = c("20-29","30-39","40-49","50-59","60-69","70-79")),
         DTHHRDY=factor(DTHHRDY,levels = c(0,1,2,3,4))) # setting the levels in this way makes "Testis" the reference  

counts.matrix <- counts.data %>% select(-Description) %>% as.matrix()
rownames(counts.matrix) <- counts.data$Description






### To find out missing Samples in counts.data
tb <- tibble(SAMPID=colnames(counts.matrix)) %>%
  mutate(E=1)

tb <- sample.description %>%
  left_join(tb)

counts.data.copy.name <- tibble(colnames(counts.data.copy))
###









dge.data <- DGEList(counts=counts.matrix, 
                    group=sample.description$group)
#dim(dge.data) 
dge.data <- calcNormFactors(dge.data, method = "TMM")
dge.data$samples

plotMDS(dge.data, method = "bcv")
```

